---
title: EES2019 Stacking Process 
subtitle: Issues in computation of Synthetic variables 
author: Giuseppe Carteny
date: 29.09.2021 
toc: true
output: 
  bookdown::pdf_document2:
    includes:
      in_header: First_steps_header.tex
urlcolor: RedOrange
---

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Admin # ==============================================================================================

want = c("tidyverse", "magrittr", "haven", "data.table", "labelled", "here", "stringr", "rlang", "car",
         "caret")
have = want %in% rownames(installed.packages())
if ( any(!have) ) { install.packages( want[!have] ) }
junk <- lapply(want, library, character.only = TRUE)
options(scipen = 99)

rm(list = ls())
# rm(list= ls()[!(ls() %in% c('keepThis','andThis'))]) # useful for further implementations

# Load & Mutate EES data # =============================================================================

# Load the full version of the EES 2019 voter study # - - - - - - - - - - - - - - - - - - - - - - - - -

EES2019 <- read_dta(here('Data', 'EES2019', 'ZA7581_v1-0-0.dta'))

# Mutate the EES 2019 voter study # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

source(here('Scripts', 'EES2019_datamut.R'))


# Source the auxiliary data set # ======================================================================

source(here('Scripts', 'aux_data_scripts', 'EES2019_cdbk_enh.R'))


# Harmonize Q25 and Q9 values # ========================================================================

source(here('Scripts', 'aux_data_scripts', 'EES2019_Q25_rec.R'))

source(here('Scripts', 'aux_data_scripts', 'EES2019_Q9_rec.R'))


# Load auxiliary functions # ===========================================================================

source(here('Scripts', 'EES2019_stack_funs.R'))


# Stack observations # =================================================================================

invisible(
  lapply(paste0(here('Scripts', 'country_spec_scripts'),'/', 
                here('Scripts', 'country_spec_scripts') %>% list.files(pattern = '_stack')),
         source)  
)

EES2019_stckd <- mget(ls(pattern = '_stack')) %>% do.call('rbind',.)
rm(list=ls(pattern='_stack'))


# Stack the original EES2019 variables # ===============================================================

EES2019_stckd %<>% left_join(., EES2019, by=c('countrycode', 'respid'))


```

# Synthetic variables estimation models {-}

## Dependent variables {-}

* Q10 for OLS models;
* Q7 for logit models.

## Independent variables  {-}

* D3_rec: R gender variable (male = 1, female = 2); 
* D4_age: R age variable; 
* D5_rec: R marital status variable (0 = single/notmarried/divorced; 1 = married);
* EDU_rec: Education variable (0 = low edu; 1 = middle edu; 2 = high edu).

## Regression models {-}

* Q10 models: Ordinary least squares (OLS);
* Q7 models: Logistic.

# Issues  {-}

In a set of countries some regression models (especially the logistic ones dedicated to estimating the 
y-hats for the vote choice variable) return either excessively high standard errors values or do not 
converge. In most cases such problem is derived by empty categories in some predictors. The following 
lines describe all the issues that have been identified and the work arounds that have been implemented. 

## Croatian sample  {-}

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Subset the EES original data frame, the SDM, and the EES codebook # ==================================

cntry = 'HR'

EES2019_hr <- EES2019 %>% filter(countryshort==cntry)
EES2019_stckd_hr <- EES2019_stckd %>% filter(countryshort==cntry)
EES2019_cdbk_hr <- EES2019_cdbk %>% filter(countryshort==cntry)

rm(cntry)

# Generic dichotomous variables estimation # ===========================================================

EES2019_hr_stack <- 
  cbind(EES2019_stckd_hr,  
        lapply(data = EES2019_stckd_hr, 
               X = list('Q2', 'Q7', 'Q9_rec', 'Q25_rec'),
               stack_var = 'party',
               FUN = gendic.fun) %>% 
          do.call('cbind',.)) %>% 
  as_tibble()

# Generic distance/proximity variables estimation # ====================================================

EES2019_hr_stack %<>%
  cbind(.,
        lapply(data = EES2019_hr,
               cdbk = EES2019_cdbk_hr,
               stack = EES2019_hr_stack, 
               crit = 'average',
               rescale = T,
               check = F,
               keep_id = F,
               X = list('Q10','Q11','Q23'),
               FUN = gendis.fun) %>% 
          do.call('cbind',.)) %>% 
  as_tibble()

# Synthetic variables estimation # =====================================================================

fit_lst <-
  gensyn.fun(data = EES2019_hr_stack,
             depvar = 'Q7_gen',
             cat.indvar =  c('D3_rec', 'D8_rec',  'D5_rec', 'EDU_rec'), #, 'D6_une' 'D6_rec', 'D9_rec'
             cont.indvar =  c('D4_age', 'D10_rec'),
             yhat.name = 'socdem',
             regsum = T)

```

While all the regression models dedicated to ptvs (OLS models) do not show any particular issue,
regression models for computing synthetic variable dedicated to respondents' vote choice for two stack 
parties appear to be problematic. In particular, the logistic models estimating the probability to vote 
for 413 "START" and 401 "Milan Bandic 365" show extremely high standard errors on one predictor 
("EDU_rec").



